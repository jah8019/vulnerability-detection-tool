import * as fs from 'fs';
import * as path from 'path';
import { Config } from '../interfaces/config';
import { VulnerabilityReport } from '../contracts/vulnerabilityReport';
import { Vulnerability, VulnerabilityType } from '../interfaces/vulnerability';

export abstract class BaseVulnerability implements Vulnerability {
    protected config: Config;
    protected patterns: Map<string, RegExp>;
    protected messages: Map<string, string>;

    constructor(configPath: string, configSection: string) {
        const configFilePath = path.resolve(__dirname, configPath);
        this.config = JSON.parse(fs.readFileSync(configFilePath, 'utf-8'))[configSection];
        this.patterns = new Map();
        this.messages = new Map();

        for (const patternConfig of this.config.patterns) {
            this.patterns.set(patternConfig.name, new RegExp(patternConfig.pattern, 'g'));
            if (patternConfig.message) {
                this.messages.set(patternConfig.name, patternConfig.message);
            }
        }
    }

    abstract detect(code: string, filePath: string): VulnerabilityReport[];

    protected getLineNumber(code: string, index: number): number {
        return code.substring(0, index).split('\n').length;
    }

    protected createReport(filePath: string, lineNumber: number, functionName: string, description: string, vulnerabilityType: VulnerabilityType): VulnerabilityReport {
        return {
            type: vulnerabilityType,
            description: `Possible vulnerability detected: ${description}.`,
            filePath: filePath,
            lineNumber: lineNumber,
            details: `The expression at line ${lineNumber} in file ${filePath} may cause a ${VulnerabilityType[vulnerabilityType]} vulnerability.`,
        };
    }
}
